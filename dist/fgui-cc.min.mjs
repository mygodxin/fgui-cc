import{Window,GComponent,UIPackage,GRoot,AsyncOperation}from"fairygui-cc";import*as mvc from"simple-mvc-cc";class AniWindow extends Window{constructor(t){return super(),this.contentPane=t,this.modal=!0,null==this.closeButton&&(this.closeButton=t.getChild("closeButton")),this}doShowAnimation(){this.touchable=!1;const t=this.contentPane.getTransition("show");t&&t.play((()=>{this.onShowAniComplete()}))}onShowAniComplete(){this.touchable=!0,this.onShown()}doHideAnimation(){this.touchable=!1;const t=this.contentPane.getTransition("hide");t&&t.play((()=>{this.hideImmediately()}))}}class FairyChild{constructor(t,e){this.windowDict={},this.windowDict={},this.setRoot(t,e)}setRoot(t,e){return this.viewComponent=t,this.owner=e,this.owner||(this.owner=this),this}onClickButton(t){this.owner!=this&&this.owner.onClickButton(t)}onCloseWindow(t){this.owner!=this&&this.owner.onCloseWindow(t)}getObj(t,e,i){void 0===i&&(i="component");var s=t.split("."),r=s.length;null==e&&(e=this.viewComponent);for(var n=0;n<r-1;++n)if(null==(e=e.getChild(s[n]).asCom))return null;switch(i){case"controller":return e?e.getController(s[n]):null;case"transition":return e?e.getTransition(s[n]):null}return e?e.getChild(s[n]):null}getComp(t){var e=this.getObj(t);return null==e?null:e}getButton(t,e,i){var s=this;null==i&&(i=this.viewComponent);var r=this.getObj(t,i);return null!=r&&r&&r.onClick((function(){e&&e.apply(s.owner),s.onClickButton(r)}),this),null==r?null:r}getLabel(t){var e=this.getObj(t);return null==e?null:e}getProgressBar(t){var e=this.getObj(t);return null==e?null:e}getTextField(t){var e=this.getObj(t);return null==e?null:e}getRichTextField(t){var e=this.getObj(t);return null==e?null:e}getTextInput(t){var e=this.getObj(t);return null==e?null:e}getLoader(t){var e=this.getObj(t);return null==e?null:e}getList(t){var e=this.getObj(t);return null==e?null:e}getGraph(t){var e=this.getObj(t);return null==e?null:e}getGroup(t){var e=this.getObj(t);return null==e?null:e}getSlider(t){var e=this.getObj(t);return null==e?null:e}getComboBox(t){var e=this.getObj(t);return null==e?null:e}getImage(t){var e=this.getObj(t);return null==e?null:e}getMovieClip(t){var e=this.getObj(t);return null==e?null:e}getController(t){return this.getObj(t,null,"controller")}getTransition(t){return this.getObj(t,null,"transition")}getWindow(t,e,i){var s=this;if(null==i&&(i=this.viewComponent),null==this.windowDict[t]){var r=new AniWindow(i.getChild(t).asCom);null==r.closeButton&&(r.closeButton=r.contentPane.getChild("closeButton")),null!=r.closeButton&&r.closeButton.onClick((function(){null!=e&&e.apply(s.owner),s.onCloseWindow(r)}),this),this.windowDict[t]=r}return this.windowDict[t]}}class MediatorUiAdapter extends mvc.Mediator{constructor(t,e){return super(t,e),this.subMediators=[],this.owner=e,this}onShow(){mvc.registerMediator(this);for(let t=0;t<this.subMediators.length;++t)mvc.registerMediator(this.subMediators[t])}onReady(){}onHide(){mvc.removeMediator(this.mediatorName);for(var t=0;t<this.subMediators.length;++t)mvc.removeMediator(this.subMediators[t].mediatorName)}bindMediator(...t){this.subMediators.push(...t)}onRegister(){this.owner&&this.owner.onRegister&&this.owner.onRegister()}get eventList(){return this.owner&&this.owner.eventList||[]}onEvent(t,e){this.owner&&this.owner.onEvent&&this.owner.onEvent(t,e)}onRemove(){this.owner&&this.owner.onRemove&&this.owner.onRemove()}}class AppComp extends GComponent{constructor(t,e){return super(),t?("string"==typeof t?(e&&!UIPackage.getByName(e)&&UIPackage.addPackage(e),this.contentPane=UIPackage.createObject(e,t).asCom):this.contentPane=t.asCom,this.addChild(this.contentPane),this.fairyAdapter=new FairyChild(this.contentPane,this),this.mediatorAdapter=new MediatorUiAdapter(e+"/"+this.name,this),this.uiMediators=[this.mediatorAdapter],this.bindChild(),this):this}bindChild(){}onResize(){}onClickButton(t){}onCloseWindow(t){}setRoot(t){this.fairyAdapter.setRoot(t)}getComp(t){return this.fairyAdapter.getComp(t)}getLabel(t){return this.fairyAdapter.getLabel(t)}getProgressBar(t){return this.fairyAdapter.getProgressBar(t)}getTextField(t){return this.fairyAdapter.getTextField(t)}getRichTextField(t){return this.fairyAdapter.getRichTextField(t)}getTextInput(t){return this.fairyAdapter.getTextInput(t)}getLoader(t){return this.fairyAdapter.getLoader(t)}getList(t){return this.fairyAdapter.getList(t)}getGraph(t){return this.fairyAdapter.getGraph(t)}getGroup(t){return this.fairyAdapter.getGroup(t)}getSlider(t){return this.fairyAdapter.getSlider(t)}getComboBox(t){return this.fairyAdapter.getComboBox(t)}getImage(t){return this.fairyAdapter.getImage(t)}getMovieClip(t){return this.fairyAdapter.getMovieClip(t)}getController(t){return this.fairyAdapter.getController(t)}getTransition(t){return this.fairyAdapter.getTransition(t)}getButton(t,e,i){return this.fairyAdapter.getButton(t,e,i)}getWindow(t,e,i){return this.fairyAdapter.getWindow(t,e,i)}get mediatorName(){return this.mediatorAdapter.mediatorName}get viewComponent(){return this}onRegister(){}onEvent(t,e){}onRemove(){}}class AlertTip extends AppComp{setAndShow(t,e,i,s){return void 0===i&&(i=1500),this.viewComponent.title=t,this.showTime=i,this.lock=s,s?(this.win||(this.win=new Window,this.win.modal=!0),this.win.contentPane=this.viewComponent,this.win.show(),this.win.center(),e>0&&(this.win.y=e)):(GRoot.inst.addChild(this),this.center(),e>0&&(this.y=e)),this.alpha=0,this}hide(){}}const EVT_FAIRY_CLICK="EVT_FAIRY_CLICK",EVT_STAGE_ADDED="EVT_STAGE_ADDED",EVT_FAIRY_SHOW="EVT_FAIRY_SHOW",EVT_STAGE_REMOVED="EVT_STAGE_REMOVED",EVT_FAIRY_HIDE="EVT_FAIRY_HIDE",EVT_STAGE_RESIZE="EVT_STAGE_RESIZE",EVT_UI_ONREADY="EVT_UI_ONREADY",EVT_UI_ONHIDE="EVT_UI_ONHIDE";var fairyUrlLocalPrefix="",fairyUrlRemotePrefix="";function getFairyPath(t){for(var e=t.name;t.parent&&t.parent!=GRoot.inst;)null==t.parent.parent||t.parent.parent instanceof Window||(e=t.parent.name+"/"+e),t=t.parent;return e}var EAlertType,instHistory=[];function getFairyInstence(t,...e){e=[];for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];for(var s=0;s<instHistory.length;++s){var r=instHistory[s];if(r.type==t)return r.inst}var n=new(t.bind.apply(t,[void 0].concat(e)));return instHistory.push({type:t,inst:n}),n}class AppWindow extends Window{constructor(t,e,...i){return super(),this.transShowName="show",this.transHideName="hide",this.subWindowsList={},this.uiMediators=[],this.name=t,this.pack=e,this.prefix=fairyUrlRemotePrefix,i.forEach((t=>{t&&this.addUISource(t)})),this.modal=!0,this.isCenter=!0,this.initConfig(),this}static show(t,e){var i=getFairyInstence(t);return i&&i.showByParams(e),i}onStageEvent(t){switch(t){case EVT_STAGE_ADDED:mvc.send(EVT_FAIRY_SHOW,{view:this.contentPane,path:getFairyPath(this)});break;case EVT_STAGE_REMOVED:mvc.send(EVT_FAIRY_HIDE,{view:this.contentPane,path:getFairyPath(this)});break;case EVT_STAGE_RESIZE:this.onResize()}}initConfig(){}show(){this.isPopup?GRoot.inst.showPopup(this):this.parent==GRoot.inst?this._inited&&(this.refreshUi(),this.onShowAniComplete()):super.show()}showByParams(t){return this.openData=t,this.show(),this}hide(){this.closeAllSubWindow(),this.doHideAnimation(),this.refreshOwnerWindow()}hideThen(t,e){this.hideThenCall=t,this.hideThenObj=e,this.hide()}init(){super.init(),this.loading&&AppWindow.configLoadingWaiting&&this.showLoadingWait()}showLoadingWait(){this.loadingWaitPane||(this.loadingWaitPane=UIPackage.createObjectFromURL(AppWindow.configLoadingWaiting)),this.layoutLoadingWaitPane(),GRoot.inst.addChild(this.loadingWaitPane)}layoutLoadingWaitPane(){this.loadingWaitPane.makeFullScreen()}closeLoadingWait(){this.loadingWaitPane&&null!=this.loadingWaitPane.parent&&this.loadingWaitPane.removeFromParent()}onInit(){this.closeLoadingWait(),null==this.contentPane&&(this.pack&&!UIPackage.getByName(this.pack)&&UIPackage.addPackage(this.prefix+this.pack),this.contentPane=UIPackage.createObject(this.pack,this.name).asCom),this.topArea=this.contentPane.getChild("top"),this.bottomArea=this.contentPane.getChild("bottom"),this.centerArea=this.contentPane.getChild("center"),this.fairyAdapter=new FairyChild(this.contentPane,this),this.mediatorAdapter=new MediatorUiAdapter(this.prefix+this.pack+"/"+this.name,this),this.uiMediators=[this.mediatorAdapter],this.bindChild()}doShowAnimation(){if(mvc.send(EVT_UI_ONREADY,this),this.onResize(),this.refreshUi(),this.registerMediators(),this.touchable=!1,this.showAnimation)this.showAnimation(this,this.onShowAniComplete);else{const t=this.contentPane.getTransition(this.transShowName);t?t.play((()=>{this.onShowAniComplete()})):this.onShowAniComplete()}}doHideAnimation(){if(this.removeMediators(),this.touchable=!1,this.hideAnimation)this.hideAnimation(this,this.onHideAniComplete);else{const t=this.contentPane.getTransition(this.transHideName);t?t.play((()=>{this.onHideAniComplete()})):this.onHideAniComplete()}}onShowAniComplete(){this.touchable=!0,this.onShown()}onHideAniComplete(){this.touchable=!0,this.hideImmediately(),this.hideThenCall&&(this.hideThenCall.call(this.hideThenObj),this.hideThenCall=null,this.hideThenObj=null),mvc.send(EVT_UI_ONHIDE,this)}onResize(){this.isFullScreen?this.makeFullScreen():this.isCenter&&this.center()}bindChild(){}refreshUi(){}onClickButton(t){}onCloseWindow(t){}onSubWindowClose(t){}registerSubWindow(t,e,i,s){return null==this.subWindowsList[e]&&(i||(i=this.pack),this.bindSubWindow(new t(e,i,s))),this.subWindowsList[e]}bindSubWindow(t){return null==this.subWindowsList[t.name]&&(t.ownerWindow=this,this.subWindowsList[t.name]=t),this.subWindowsList[t.name]}showSubWindow(t,e){var i=this.subWindowsList[t];if(null!=i)return(e||null===e)&&(i.openData=e),i.show(),i}closeAllSubWindow(){for(var t in this.subWindowsList)this.subWindowsList[t].hide()}refreshOwnerWindow(){this.ownerWindow&&this.ownerWindow.onSubWindowClose(this)}registerMediators(){for(var t=0;t<this.uiMediators.length;++t)mvc.registerMediator(this.uiMediators[t])}removeMediators(){for(var t=0;t<this.uiMediators.length;++t)mvc.removeMediator(this.uiMediators[t].mediatorName)}setRoot(t){this.fairyAdapter.setRoot(t)}getComp(t){return this.fairyAdapter.getComp(t)}getLabel(t){return this.fairyAdapter.getLabel(t)}getProgressBar(t){return this.fairyAdapter.getProgressBar(t)}getTextField(t){return this.fairyAdapter.getTextField(t)}getRichTextField(t){return this.fairyAdapter.getRichTextField(t)}getTextInput(t){return this.fairyAdapter.getTextInput(t)}getLoader(t){return this.fairyAdapter.getLoader(t)}getList(t){return this.fairyAdapter.getList(t)}getGraph(t){return this.fairyAdapter.getGraph(t)}getGroup(t){return this.fairyAdapter.getGroup(t)}getSlider(t){return this.fairyAdapter.getSlider(t)}getComboBox(t){return this.fairyAdapter.getComboBox(t)}getImage(t){return this.fairyAdapter.getImage(t)}getMovieClip(t){return this.fairyAdapter.getMovieClip(t)}getController(t){return this.fairyAdapter.getController(t)}getTransition(t){return this.fairyAdapter.getTransition(t)}getButton(t,e,i){return this.fairyAdapter.getButton(t,e,i)}getWindow(t,e,i){return this.fairyAdapter.getWindow(t,e,i)}get mediatorName(){return this.mediatorAdapter.mediatorName}get viewComponent(){return this}onRegister(){}onEvent(t,e){}onRemove(){}}!function(t){t[t.DOUBLE=0]="DOUBLE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.SWAP=3]="SWAP",t[t.NONE=4]="NONE"}(EAlertType||(EAlertType={}));class AlertWindow extends AppWindow{bindChild(){this.stateCtrl=this.getController("state"),this.topCtrl=this.getController("frame.top"),this.leftButton=this.getButton("leftButton"),this.rightButton=this.getButton("rightButton"),this.contentTextFiled=this.getTextField("contentTextFiled")}setAndShow(t,e){return void 0===e&&(e={}),this.contentString=t,this.param=e,this.show(),this}refreshUi(){this.topCtrl&&(this.topCtrl.selectedIndex=this.param.noClose?1:0),1!==this.param.type&&2!==this.param.type&&3!==this.param.type&&(this.param.type=0),this.stateCtrl.selectedIndex=this.param.type,this.contentTextFiled.text=this.contentString,this.param.title&&(this.frame.icon=this.param.title),this.param.textL&&(this.leftButton.title=this.param.textL),this.param.textR&&(this.rightButton.title=this.param.textR)}onClickButton(t){switch(t){case this.leftButton:this.param.type==EAlertType.SWAP?this.onClickRight():this.onClickLeft();break;case this.rightButton:this.param.type==EAlertType.SWAP?this.onClickLeft():this.onClickRight()}}onClickLeft(){this.param.stayL||this.hide(),"function"==typeof this.param.subL&&this.param.subL.call(this.param.objL||this.param.thisObj||this)}onClickRight(){this.param.stayL||this.hide(),"function"==typeof this.param.subR&&this.param.subR.call(this.param.objR||this.param.thisObj||this)}hide(){super.hide(),"function"==typeof this.param.onClose&&this.param.onClose.call(this.param.objCLose||this.param.thisObj||this)}}class AppScene extends AppWindow{static show(t,e){var i=getFairyInstence(t);return i&&i.showByParams(e),i}initConfig(){this.modal=!1,this.isCenter=!1,this.isFullScreen=!0,this.bringToFontOnClick=!1}show(){let t=GRoot.inst._children.concat();for(var e=1;e<t.length;e++){let i=t[e];i instanceof AppScene||i.removeFromParent()}if(null==AppScene.current)AppScene.current=this,super.show(),mvc.on(EVT_STAGE_RESIZE,this.onResize,this);else if(AppScene.current==this)super.show();else{var i=AppScene.current;AppScene.current=null,i.hideThen(this.show,this)}}onHide(){mvc.off(EVT_STAGE_RESIZE,this.onResize,this)}}const EVT_SourceLoader_CompleteEvent="EVT_SourceLoader_CompleteEvent",EVT_SourceLoader_FailEvent="EVT_SL_Fail",EVT_SourceLoader_ErrorEvent="EVT_SL_Error",EVT_SourceLoader_ProgressEvent="EVT_SourceLoader_ProgressEvent";class ASourceLoader{constructor(){this.progress=function(t,e){this.completedCount=t,this.totalCount=e,mvc.send(EVT_SourceLoader_ProgressEvent,this)},this.loaded=!1,this.callbacks=[],this.thisObjs=[],this.failbacks=[],this.failObjs=[],this.loading=!1,this.retry=0,this.startime=0,this.loadtime=0,this.completedCount=0,this.totalCount=0}load(t,e,i){if(t){var s=this.callbacks.indexOf(t),r=this.thisObjs.indexOf(e);-1==s&&-1==r&&(this.callbacks.push(t),this.thisObjs.push(e))}this.loaded?this.complete():this.loading||(this.succeed=!1,this.loading=!0,this.startime=Date.now(),this.loadtime=0,this.retry+=1,this.start(i))}fail(t,e){if(t&&e){var i=this.failbacks.indexOf(t),s=this.failObjs.indexOf(e);-1==i&&-1==s&&(this.failbacks.push(t),this.failObjs.push(e))}}complete(){this.loading=!1,this.succeed=!0,this.loadtime+=Date.now()-this.startime,mvc.send(EVT_SourceLoader_CompleteEvent,this);for(var t=0;t<this.callbacks.length;++t){var e=this.callbacks[t],i=this.thisObjs[t];e&&e.apply(i)}this.callbacks=[],this.thisObjs=[]}success(){this.isPreload=!1,this.complete()}onfailed(){this.loading=!1,this.failed=!0,mvc.send("EVT_SL_Fail",this);for(var t=0,e=this.failbacks.length;t<e;t++){var i=this.failbacks[t],s=this.failObjs[t];i&&i.apply(s)}this.failbacks=[],this.failObjs=[]}}class FairyLoader extends ASourceLoader{constructor(t,e,i,s,...r){return super(),this.packName=t,this.bundle=e,this}start(){if(this.bundle)UIPackage.loadPackage(this.bundle,this.fileName,this.onLoadProcess.bind(this),this.onPackLoaded.bind(this));else{var t=fairyUrlLocalPrefix+this.fileName;UIPackage.loadPackage(t,this.onLoadProcess.bind(this),this.onPackLoaded.bind(this))}}onLoadProcess(t,e){super.progress(t,e)}onPackLoaded(t,e){t||this.preCreateAppWindow()}preCreateAppWindow(t){var e=this;if(void 0===t&&(t=0),0==t&&UIPackage.addPackage(fairyUrlLocalPrefix+this.fileName),this.data&&this.data.length>0&&t<this.data.length){var i=this.data[t].inst,s=new AsyncOperation;s.callback=function(s){i.contentPane=s.asCom,e.preCreateAppWindow(t+1)},s.createObject(this.fileName,i.name)}else super.success()}}class SourcePreLoader{constructor(){this.isLoading=!1,this.isComplete=!1,this.hasError=!1,this.numRetrys=5,mvc.on(EVT_SourceLoader_CompleteEvent,this.onItemLoaded,this),mvc.on("EVT_SL_Error",this.onItemLoaded,this),this.loaderList=[]}addSource(...t){this.loaderList=t,this._numSources=this.loaderList.length}preload(t){if(void 0===t&&(t=0),!this.isComplete)if(t>=this._numSources){for(var e=0;e<this._numSources;++e){var i=this.loaderList[e];if(!i.loaded){if(i.retry<this.numRetrys)return void this.preload(e);this.hasError=!0}}this.hasError||(this.isComplete=!0)}else{var s=this.loaderList[t];if(s.loading||s.loaded)this.preload(t+1);else{if(s.retry>=7)return this.hasError=!0,void this.preload(t+1);this.isLoading=!0,this.loadPosition=t,s.load()}}}onItemLoaded(t){var e=this.loaderList.indexOf(t);-1!=e&&this.loadPosition==e&&this.preload(e+1)}reload(){if(!this.isLoading&&this.isComplete&&this.hasError){this.isComplete=!1,this.hasError=!1;for(var t=0;t<this.loaderList.length;++t)this.loaderList[t].retry=0;this.preload()}}forEach(t){for(var e=0;e<this._numSources;++e)t(e,this.loaderList[e])}}export{ASourceLoader,AlertTip,AlertWindow,AniWindow,AppComp,AppScene,AppWindow,EAlertType,EVT_FAIRY_CLICK,EVT_FAIRY_HIDE,EVT_FAIRY_SHOW,EVT_STAGE_ADDED,EVT_STAGE_REMOVED,EVT_STAGE_RESIZE,EVT_SourceLoader_CompleteEvent,EVT_SourceLoader_ErrorEvent,EVT_SourceLoader_FailEvent,EVT_SourceLoader_ProgressEvent,EVT_UI_ONHIDE,EVT_UI_ONREADY,FairyChild,FairyLoader,SourcePreLoader,getFairyInstence,getFairyPath};